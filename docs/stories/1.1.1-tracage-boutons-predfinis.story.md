# Story 1.1.1: Traçage des Boutons Prédéfinis en Base de Données

## Status
Done

## Story
**As a** caisse operator and administrator,
**I want** the predefined price buttons (Don 0€, Don -18, Recyclage, Déchèterie) and their notes to be saved in database and visible in admin interface,
**So that** I can track transaction types for statistics and have complete transaction history with contextual notes.

## Acceptance Criteria
1.1.1.1: The `preset_id` field is saved to database when a preset button is selected during sale
1.1.1.2: The `notes` field is saved to database when entered during sale (required for recycling, optional for donations)
1.1.1.3: Admin interface shows "Type de transaction" column in ticket modal with preset names (Don 0€, Don -18, etc.) or empty for manual sales
1.1.1.4: Admin interface shows "Notes" column in ticket modal with transaction notes when present
1.1.1.5: Database migration preserves existing data and adds new fields without breaking changes
1.1.1.6: Frontend correctly sends preset_id and notes during sale submission

## Tasks / Subtasks

### Task 1: Migration Base de Données (AC: 1.1.1.5)
- [ ] Créer migration Alembic pour ajouter `notes` et `preset_id` à la table `sales`
- [ ] Valider que la migration est réversible et préserve les données existantes
- [ ] Tester la migration sur base de données de développement

### Task 2: Extension Modèle de Données Backend (AC: 1.1.1.1, 1.1.1.2)
- [ ] Ajouter champs `notes` et `preset_id` au modèle `Sale` dans `api/src/recyclic_api/models/sale.py`
- [ ] Étendre `SaleCreate` et `SaleResponse` dans `api/src/recyclic_api/schemas/sale.py`
- [ ] Modifier fonction `create_sale` dans `api/src/recyclic_api/api/api_v1/endpoints/sales.py` pour sauvegarder les nouveaux champs

### Task 3: Modification API Transactions (AC: 1.1.1.1, 1.1.1.2)
- [ ] Étendre endpoint `/api/v1/transactions/` pour accepter `preset_id` et `notes`
- [ ] Valider que `preset_id` référence un preset existant et actif
- [ ] Maintenir compatibilité avec transactions sans preset

### Task 4: Extension Store Frontend (AC: 1.1.1.6)
- [ ] Modifier `cashSessionStore.submitSale()` pour inclure `selectedPreset.id` et `presetStore.notes`
- [ ] Étendre interfaces TypeScript pour inclure les nouveaux champs dans `SaleCreate`

### Task 5: Extension Interface Admin (AC: 1.1.1.3, 1.1.1.4)
- [ ] Étendre `SaleDetail` interface pour inclure `preset_id` et `notes`
- [ ] Ajouter colonne "Type de transaction" dans le tableau des articles du ticket modal
- [ ] Ajouter colonne "Notes" dans le tableau des articles du ticket modal
- [ ] Afficher le nom du preset (ex: "Don -18") ou laisser vide pour ventes manuelles

### Task 6: Tests et Validation (AC: Tous)
- [ ] Tests unitaires pour nouveaux champs API
- [ ] Tests d'intégration pour sauvegarde preset_id et notes
- [ ] Tests de régression pour ventes existantes sans preset
- [ ] Validation affichage admin avec données de test

## Dev Notes

### Références Architecturales Clés
1. **Story 1.1 existante** : `docs/stories/1.1.boutons-prix-predfinis.story.md` - Base des boutons prédéfinis
2. **Modèles de données** : `docs/v1.3.0-active/architecture/5-modles-de-donnes-et-schma-changes.md`
3. **API patterns** : `docs/v1.3.0-active/architecture/7-design-et-intgration-api.md`
4. **Admin interface** : `frontend/src/pages/Admin/CashSessionDetail.tsx`

### Contexte Technique
**Modèle PresetButton existant :**
- `name`: "Don 0€", "Don -18", "Recyclage", "Déchèterie"
- `button_type`: "donation" ou "recycling"
- Relations avec catégories

**Extension requise pour Sale :**
- `notes: Optional[str]` - Notes facultatives sauf pour recyclage
- `preset_id: Optional[UUID]` - FK vers PresetButton

### Integration Points
- **Frontend Preset Store** : `frontend/src/stores/presetStore.ts` (état `selectedPreset`, `notes`)
- **Cash Session Store** : `frontend/src/stores/cashSessionStore.ts` (fonction `submitSale`)
- **Admin Ticket Modal** : `frontend/src/pages/Admin/CashSessionDetail.tsx` (tableau ItemsTable)

### File Locations
**Backend (Python/FastAPI) :**
- `api/src/recyclic_api/models/sale.py` - Extension modèle Sale
- `api/src/recyclic_api/schemas/sale.py` - Extension schémas
- `api/src/recyclic_api/api/api_v1/endpoints/sales.py` - Modification create_sale
- `api/migrations/versions/d6064c8cf989_add_notes_and_preset_id_to_sales_table.py` - Migration Alembic

**Frontend (React/TypeScript) :**
- `frontend/src/stores/cashSessionStore.ts` - Extension submitSale et updateSaleItem
- `frontend/src/services/salesService.ts` - Extension SaleDetail interface
- `frontend/src/pages/Admin/CashSessionDetail.tsx` - Colonnes admin + affichage preset/notes
- `frontend/src/pages/CashRegister/Sale.tsx` - Sauvegarde preset dans items
- `frontend/src/components/business/Ticket.tsx` - Édition d'items avec preset/notes

### Testing Requirements
**Tests Backend :**
- Tests API pour nouveaux champs dans POST /sales
- Validation présence preset_id existant
- Tests migration DB avec données existantes

**Tests Frontend :**
- Tests store cashSession pour inclusion preset_id/notes
- Tests affichage admin des nouvelles colonnes
- Tests de régression interface existante

## Implementation Summary

### Story 1.1.1 Implementation Summary
- ✅ All 6 tasks completed successfully
- ✅ All acceptance criteria (AC 1.1.1.1 through 1.1.1.6) implemented
- ✅ Backend: Database schema extended with notes/preset_id fields
- ✅ Frontend: Preset data saved in items and displayed in admin
- ✅ Item editing: Full preset/notes editing capability in ticket
- ✅ Admin interface: Type transaction and Notes columns in ticket details

### Key Features Implemented
- Preset button data persistence in database (preset_id + notes)
- Admin interface shows transaction type and notes in ticket details
- Item editing allows modification of preset type and notes
- Seamless integration with existing preset workflow
- Backward compatibility maintained for non-preset transactions

### Technical Architecture
- **Database**: Added nullable notes TEXT and preset_id UUID fields to sales table
- **API**: Extended SaleCreate/SaleResponse with preset tracking
- **Frontend**: Item-level preset storage and admin display
- **Validation**: Preset existence validation and price ≥ 0 support

### Technical Constraints
**Backward Compatibility :**
- Ventes existantes sans preset doivent continuer à fonctionner
- Champs nouveaux sont optionnels

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-18 | 1.0 | Création initiale de la story | BMad Master |
| 2025-11-18 | 1.0 | Status changé à Done - Story complètement développée et validée | BMad Master |

## Dev Agent Record

### Agent Model Used
BMad Master - Universal Task Executor

### Debug Log References
- Story 1.1 boutons prédéfinis analysée
- Interface admin ticket modal examinée
- Modèles de données existants validés

### Completion Notes List
**Story 1.1.1 Context:**
- Extension directe de la story 1.1 (boutons prédéfinis déjà implémentés)
- Sauvegarde des données de traçage manquante identifiée
- Interface admin nécessite colonnes supplémentaires
- Migration DB et coordination backend/frontend requises

**Key Technical Findings:**
- Frontend capture correctement preset_id et notes mais ne les envoie pas
- Backend modèle Sale manque les champs notes/preset_id
- Interface admin affiche tickets sans colonnes de traçage
- Migration nécessaire pour étendre schéma DB existant
