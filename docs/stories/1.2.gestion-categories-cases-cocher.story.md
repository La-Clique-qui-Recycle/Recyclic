# Story 1.2: Gestion Cat√©gories Cases √† Cocher

## Status
In Development - Tasks 1-7 completed, Tests pending

## Story
**As a** caisse administrator,
**I want** checkboxes to control category display in ENTRY tickets (d√©p√¥t only) so that I can customize which categories appear for different types of users.

**‚ö†Ô∏è IMPORTANT SCOPE LIMITATION:**
This feature ONLY affects ENTRY/DEPOT tickets. SALE/CASH REGISTER tickets must display ALL categories regardless of visibility settings.

## Acceptance Criteria
1.2.1: Categories display includes checkbox for ticket visibility control (ENTRY tickets only)
1.2.2: If no subcategories of a main category are displayed, selecting the main category is sufficient (ENTRY tickets only)
1.2.3: Category selection logic automatically adapts to visibility settings (ENTRY tickets only)
1.2.4: Changes are persisted and applied immediately (ENTRY tickets only)

**SCOPE VERIFICATION:**
- ‚úÖ ENTRY/DEPOT tickets: Respect visibility settings
- ‚ùå SALE/CASH REGISTER tickets: Display ALL categories always

## Tasks / Subtasks

- [x] **Task 1: √âtendre le mod√®le Category existant** (AC: 1.2.1, 1.2.2, 1.2.3, 1.2.4)
  - [x] Ajouter les nouveaux champs dans `api/src/recyclic_api/models/category.py`:
    - `display_order`: Integer avec valeur par d√©faut
    - `is_visible`: Boolean avec valeur par d√©faut true
    - `shortcut_key`: String optionnel pour raccourcis clavier
  - [x] Cr√©er la migration Alembic pour les nouveaux champs
  - [x] Mettre √† jour les index de performance (display_order, is_visible)

- [x] **Task 2: Cr√©er le service CategoryManagementService √©tendu** (AC: 1.2.1, 1.2.3, 1.2.4)
  - [x] Cr√©er `api/src/recyclic_api/services/category_management.py`
  - [x] Impl√©menter les m√©thodes pour g√©rer la visibilit√© des cat√©gories
  - [x] Ajouter logique de filtrage des cat√©gories selon visibilit√©
  - [x] Int√©grer avec CategoryService existant

- [x] **Task 3: √âtendre les endpoints API pour la gestion cat√©gories** (AC: 1.2.1, 1.2.4)
  - [x] √âtendre GET /api/v1/categories pour inclure les nouveaux champs
  - [x] Ajouter PUT /api/v1/categories/{id}/visibility pour mettre √† jour visibilit√©
  - [x] Ajouter PUT /api/v1/categories/{id}/display-order pour r√©organiser l'ordre
  - [x] Valider les contraintes de visibilit√© (au moins une cat√©gorie visible)

- [x] **Task 4: √âtendre le store Zustand categoryStore** (AC: 1.2.1, 1.2.3, 1.2.4)
  - [x] √âtendre `frontend/src/stores/categoryStore.ts` existant
  - [x] Ajouter actions: toggleCategoryVisibility, updateDisplayOrder, fetchVisibleCategories
  - [x] G√©rer l'√©tat des param√®tres de visibilit√© par cat√©gorie
  - [x] Impl√©menter la logique de filtrage c√¥t√© client

- [x] **Task 5: Cr√©er le composant EnhancedCategorySelector** (AC: 1.2.1, 1.2.2)
  - [x] Cr√©er `frontend/src/components/categories/EnhancedCategorySelector.tsx`
  - [x] Int√©grer les cases √† cocher Mantine Checkbox pour contr√¥le visibilit√©
  - [x] Impl√©menter la logique hi√©rarchique (cat√©gorie principale suffit si sous-cat√©gories masqu√©es)
  - [x] G√©rer l'ordre d'affichage personnalisable

- [x] **Task 6: Cr√©er le composant CategoryDisplayManager** (AC: 1.2.3, 1.2.4)
  - [x] Cr√©er `frontend/src/components/categories/CategoryDisplayManager.tsx`
  - [x] Impl√©menter la logique d'adaptation automatique de la s√©lection
  - [x] G√©rer la persistance imm√©diate des changements
  - [x] Int√©grer avec les composants de tickets existants

- [x] **Task 7: Int√©grer dans l'interface d'administration** (AC: 1.2.1, 1.2.4)
  - [x] Ajouter une section "Gestion des Cat√©gories" dans l'interface admin
  - [x] Int√©grer EnhancedCategorySelector dans les param√®tres de caisse
  - [x] Pr√©server les workflows d'administration existants

- [ ] **Task 8: Tests unitaires et d'int√©gration** (AC: Tous)
  - [ ] Tests unitaires EnhancedCategorySelector: rendu checkboxes, gestion √©tat visibilit√©
  - [ ] Tests CategoryDisplayManager: logique d'adaptation s√©lection, persistance
  - [ ] Tests d'int√©gration: categoryStore + API, filtrage cat√©gories visible
  - [ ] Tests de r√©gression: hi√©rarchie cat√©gories pr√©serv√©e, performances queries

## Dev Notes

### R√©f√©rences Architecturales Cl√©s
1. **COMMENCER PAR**: `docs/v1.3.0-active/architecture/index.md` - Navigation compl√®te de l'architecture (19 fichiers total)
2. **Mod√®les de Donn√©es**: `docs/v1.3.0-active/architecture/5-modles-de-donnes-et-schma-changes.md` - Extension mod√®le Category avec display_order, is_visible, shortcut_key
3. **Architecture Composants**: `docs/v1.3.0-active/architecture/6-architecture-des-composants.md` - Sp√©cifications EnhancedCategorySelector et CategoryDisplayManager
4. **Structure Projet**: `docs/v1.3.0-active/architecture/8-intgration-dans-larborescence-source.md` - Chemins exacts pour extensions cat√©gories
5. **Standards Codage**: `docs/v1.3.0-active/architecture/10-standards-de-codage-et-conventions.md` - Patterns composants React et services Python
6. **Strat√©gie de Test**: `docs/v1.3.0-active/architecture/11-stratgie-de-test.md` - Requirements couverture et patterns de test

### Previous Story Insights
**Story 1.1** - Boutons de prix pr√©d√©finis:
- Mod√®le PresetButton cr√©√© avec relations cat√©gories
- Service PresetManagementService √©tabli
- Int√©gration API pour nouveaux endpoints
- Patterns Zustand stores valid√©s pour nouveaux domaines fonctionnels

### Data Models
**Extension Mod√®le Category** [Source: architecture/5-modles-de-donnes-et-schma-changes.md]:
- `display_order`: Integer - Ordre d'affichage personnalisable (d√©faut: 0)
- `is_visible`: Boolean - Contr√¥le affichage dans tickets (d√©faut: true)
- `shortcut_key`: String - Raccourci clavier associ√© (optionnel, nullable)

**Relations Pr√©serv√©es** [Source: architecture/5-modles-de-donnes-et-schma-changes.md]:
- Extension 1:1 avec Deposit.category (hi√©rarchie existante maintenue)
- Relations avec PresetButtons (de Story 1.1) pr√©serv√©es

### API Specifications
**Extensions Endpoints Existants** [Source: architecture/7-design-et-intgration-api.md]:
- GET /api/v1/categories √©tendu: inclure display_order, is_visible, shortcut_key
- PUT /api/v1/categories/{id}/visibility: {is_visible: boolean}
- PUT /api/v1/categories/{id}/display-order: {display_order: integer}

**Contraintes Validation** [Source: architecture/7-design-et-intgration-api.md]:
- Au moins une cat√©gorie doit rester visible
- display_order doit √™tre unique par niveau hi√©rarchique
- Validation c√¥t√© serveur pour toutes modifications

### Component Specifications
**EnhancedCategorySelector** [Source: architecture/6-architecture-des-composants.md]:
- Extension du s√©lecteur cat√©gories existant
- Cases √† cocher Mantine pour contr√¥le visibilit√© par cat√©gorie
- Logique hi√©rarchique: s√©lection cat√©gorie principale suffit si sous-cat√©gories masqu√©es
- Ordre d'affichage personnalisable via drag & drop ou contr√¥les

**CategoryDisplayManager** [Source: architecture/6-architecture-des-composants.md]:
- Gestion centralis√©e de l'affichage des cat√©gories
- Adaptation automatique de la logique de s√©lection selon param√®tres visibilit√©
- Int√©gration avec composants tickets existants
- Persistance imm√©diate via API calls optimis√©s

### File Locations
**Backend (Python/FastAPI)** [Source: architecture/8-intgration-dans-larborescence-source.md]:
- `api/src/recyclic_api/models/category.py` - Extension mod√®le existant
- `api/src/recyclic_api/services/category_management.py` - Nouveau service sp√©cialis√©
- `api/src/recyclic_api/api/api_v1/api.py` - Extensions endpoints cat√©gories

**Frontend (React/TypeScript)** [Source: architecture/8-intgration-dans-larborescence-source.md]:
- `frontend/src/stores/categoryStore.ts` - Extension store existant
- `frontend/src/components/categories/EnhancedCategorySelector.tsx` - Nouveau composant
- `frontend/src/components/categories/CategoryDisplayManager.tsx` - Nouveau composant

### Testing Requirements
**Tests Critiques** [Source: architecture/11-stratgie-de-test.md]:
- Tests hi√©rarchie cat√©gories: logique visibilit√© et s√©lection automatique
- Tests performance: requ√™tes filtr√©es sans impact sur performance existante
- Tests int√©gration: synchronisation store-API pour param√®tres visibilit√©
- Tests r√©gression: workflows cr√©ation tickets pr√©serv√©s

**Couverture Minimum** [Source: architecture/11-stratgie-de-test.md]:
- 85% pour nouveaux composants EnhancedCategorySelector et CategoryDisplayManager
- Tests E2E pour workflows administration cat√©gories
- Validation contraintes base de donn√©es

### Technical Constraints
**Scope Limitations** [CRITICAL]:
- ‚úÖ ENTRY/DEPOT tickets ONLY: Appliquent les filtres de visibilit√©
- ‚ùå SALE/CASH REGISTER tickets: TOUJOURS afficher TOUTES les cat√©gories
- üîç Implementation: Logique conditionnelle bas√©e sur le contexte (entry vs sale)

**Performance Queries** [Source: architecture/9-infrastructure-et-dploiement.md]:
- Filtrage visibilit√© doit utiliser index optimis√©s
- Impact performance < 5% sur queries cat√©gories existantes
- Cache Redis pour param√®tres visibilit√© fr√©quemment consult√©s

**Backward Compatibility** [Source: architecture/1-introduction.md]:
- Valeurs par d√©faut pr√©servent comportement existant (is_visible=true)
- Hi√©rarchie cat√©gories existante compl√®tement pr√©serv√©e
- APIs existantes retournent champs suppl√©mentaires sans breaking changes
- SALE/CASH REGISTER workflows inchang√©s

**S√©curit√©** [Source: architecture/12-intgration-scurit.md]:
- Contr√¥le d'acc√®s administration cat√©gories (r√¥les admin uniquement)
- Validation stricte des modifications visibilit√©
- Audit logs pour changements param√®tres cat√©gories

## Testing

### Testing
**Strat√©gie de Test** [Source: architecture/11-stratgie-de-test.md]:
- Tests unitaires: logique composants EnhancedCategorySelector et CategoryDisplayManager
- Tests int√©gration: categoryStore + API cat√©gories, filtrage visibilit√©
- Tests r√©gression: hi√©rarchie cat√©gories pr√©serv√©e, performances queries
- Tests E2E: workflows administration param√®tres cat√©gories

**Sc√©narios de Test Critiques**:
- AC 1.2.1: Cases √† cocher pr√©sentes et fonctionnelles pour chaque cat√©gorie
- AC 1.2.2: Logique hi√©rarchique (cat√©gorie principale suffit si sous-cat√©gories masqu√©es)
- AC 1.2.3: Adaptation automatique logique s√©lection selon visibilit√©
- AC 1.2.4: Persistance imm√©diate changements via API

**M√©triques de Succ√®s**:
- Tests passent avec >85% couverture nouveaux composants
- Performance queries cat√©gories d√©grad√©e <5%
- Aucun breaking change workflows existants

### Testing Instructions
**Outils de Test :**
- **DevTools Browser** (F12) pour inspecter les appels API et l'√©tat des composants
- **Comptes de test :**
  - Super Admin: `superadmintest1` / `Test1234!`
  - Admin: `admintest1` / `Test1234!`
  - URLs: Frontend `http://localhost:4444`, API `http://localhost:4433`

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Cr√©ation initiale de la story | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
James (Dev Agent)

### Debug Log References

### Completion Notes List
- **Task 1-7 compl√©t√©es**: Mod√®le Category √©tendu avec display_order, is_visible, shortcut_key
- **Migration cr√©√©e**: `add_category_visibility_fields.py` avec index de performance
- **Service cr√©√©**: CategoryManagementService avec logique de filtrage selon ticket type (ENTRY vs SALE)
- **Endpoints ajout√©s**: PUT /visibility, PUT /display-order, GET /entry-tickets, GET /sale-tickets
- **Store √©tendu**: Actions toggleCategoryVisibility, updateDisplayOrder, fetchVisibleCategories
- **Composants cr√©√©s**: EnhancedCategorySelector (avec checkboxes) et CategoryDisplayManager
- **Int√©gration admin**: Onglet "Visibilit√© pour tickets ENTRY" dans la page Admin/Categories
- **Scope respect√©**: ENTRY tickets respectent visibilit√©, SALE tickets affichent toujours toutes les cat√©gories
- **AC 1.2.2 impl√©ment√©**: Logique hi√©rarchique - cat√©gorie principale suffit si sous-cat√©gories masqu√©es

### File List
**Backend:**
- `api/src/recyclic_api/models/category.py` - Mod√®le √©tendu avec nouveaux champs
- `api/src/recyclic_api/schemas/category.py` - Sch√©mas Pydantic mis √† jour
- `api/src/recyclic_api/services/category_service.py` - Service mis √† jour pour utiliser nouveaux champs
- `api/src/recyclic_api/services/category_management.py` - Nouveau service pour gestion visibilit√©
- `api/src/recyclic_api/api/api_v1/endpoints/categories.py` - Endpoints √©tendus
- `api/migrations/versions/add_category_visibility_fields.py` - Migration Alembic

**Frontend:**
- `frontend/src/services/categoryService.ts` - Interface Category √©tendue, nouvelles m√©thodes API
- `frontend/src/stores/categoryStore.ts` - Store √©tendu avec actions visibilit√©
- `frontend/src/components/categories/EnhancedCategorySelector.tsx` - Composant avec checkboxes
- `frontend/src/components/categories/CategoryDisplayManager.tsx` - Gestionnaire d'affichage
- `frontend/src/pages/Admin/Categories.tsx` - Int√©gration onglet visibilit√©

## QA Results
