# Story 5.3: Ticket Temps Réel & Gestion Erreurs

**Status:** Draft

## Story

**As a** cashier,
**I want** to see a live ticket with running total and edit capabilities,
**so that** I can correct mistakes and track the current sale accurately.

## Acceptance Criteria

1. Colonne ticket affichage temps réel (lignes + total cumulé)
2. Édition lignes : modifier quantité, prix, supprimer
3. Validation admin requise pour certaines corrections (config)
4. Sauvegarde automatique locale toutes les 30 secondes
5. Mode de paiement sélectionnable (Espèces, Chèques)
6. Finalisation vente → enregistrement BDD + impression ticket

## Dev Notes

### Références Architecturales Clés
1. **COMMENCER PAR**: `docs/architecture/index.md` - Navigation complète de l'architecture (19 sections total, index fournit navigation)
2. `docs/architecture/4-alignement-de-la-stack-technologique.md` - Stack technologique React/Mantine/Zustand
3. `docs/architecture/8-intgration-dans-larborescence-source.md` - Structure frontend avec composants dans dossiers logiques
4. `docs/architecture/11-stratgie-de-test.md` - Tests Vitest/React Testing Library, couverture 85% pour nouveaux composants
5. `docs/architecture/6-architecture-des-composants.md` - Composants TicketScroller et interactions store
6. `docs/architecture/5-modles-de-donnes-et-schma-changes.md` - Modèle sales avec unit_price, total_amount calculé
7. `docs/architecture/appendix-database-schema.md` - Table sales avec payment_method enum (cash/card/check)

### Contexte / stories précédentes
- Story 5.1 (Ouverture Session) et 5.2 (Interface Vente Multi-Modes) complétées avec stores Zustand étendus
- Store cashSessionStore.ts étendu avec sale management (currentSaleItems, addSaleItem, submitSale)
- Composant Sale.tsx complet avec sélecteurs catégories et numpad intégré
- Pattern Mantine et Zustand existants strictement respectés pour cohérence

### Insights Techniques
- **Table Sales**: Structure avec category_eee, quantity, unit_price, total_amount (calculé), payment_method [Source: appendix-database-schema.md]
- **Payment Methods**: Enum (cash/card/check) - interface doit supporter "Espèces" et "Chèques" (AC5) [Source: appendix-database-schema.md]
- **Component Architecture**: TicketScroller pour navigation tickets longs, intégré dans workflow existant [Source: 6-architecture-des-composants.md]
- **State Management**: Extension cashSessionStore avec gestion items vente et API integration [Source: 8-intgration-dans-larborescence-source.md]
- **Local Storage**: Sauvegarde automatique toutes 30 secondes pour PWA offline-first [Source: 3-porte-et-stratgie-dintgration.md]
- **Error Handling**: Gestion erreurs au niveau composant avec Error Boundaries [Source: 10-standards-de-codage-et-conventions.md]
- **Validation Admin**: Configuration pour corrections nécessitant validation admin [Source: 6-architecture-des-composants.md]

### Technical Constraints
- Framework React 18.2.0 avec Mantine 8.3.1 maintenu [Source: 4-alignement-de-la-stack-technologique.md]
- State management Zustand 5.0.8 pour stores spécialisés par domaine [Source: 4-alignement-de-la-stack-technologique.md]
- Tests unitaires Vitest + React Testing Library, couverture 85% minimum [Source: 11-stratgie-de-test.md]
- Organisation composants: `frontend/src/components/tickets/` pour composants ticket [Source: 8-intgration-dans-larborescence-source.md]
- API endpoints existants étendus, backward compatibility maintenue [Source: 3-porte-et-stratgie-dintgration.md]

## Tasks / Subtasks

1. **Création composant TicketDisplay temps réel (AC1)**
   - Créer `frontend/src/components/tickets/TicketDisplay.tsx` avec liste items et total cumulé
   - Intégrer avec cashSessionStore pour données temps réel
   - Implémenter affichage responsive gros boutons/tablette
   - Tests unitaires couverture interactions store

2. **Fonctionnalités édition ticket (AC2)**
   - Ajouter boutons modifier quantité/prix/supprimer par ligne
   - Implémenter modales/popups édition avec validation
   - Extension cashSessionStore avec méthodes updateSaleItem/removeSaleItem
   - Tests intégration modifications ticket

3. **Validation admin pour corrections (AC3)**
   - Configuration feature flag pour corrections nécessitant validation
   - Interface confirmation admin avec workflow approbation
   - Logging corrections sensibles avec audit trail
   - Tests scénarios validation admin

4. **Sauvegarde automatique locale (AC4)**
   - Timer 30 secondes sauvegarde IndexedDB/localStorage
   - Gestion états offline avec synchronisation reconnection
   - Indicateur visuel sauvegarde en cours/succès
   - Tests persistance données hors ligne

5. **Sélection mode paiement (AC5)**
   - Composant sélecteur paiement avec options "Espèces"/"Chèques"
   - Validation choix avant finalisation vente
   - Intégration enum payment_method (cash/check)
   - Tests workflow paiement complet

6. **Finalisation vente et enregistrement (AC6)**
   - API endpoint POST /api/sales/ pour soumission vente
   - Gestion erreurs réseau avec retry/backoff
   - Workflow impression ticket après enregistrement BDD
   - Tests end-to-end vente complète

7. **Tests de régression et intégration (AC1-6)**
   - Suite tests Vitest couverture 85% nouveaux composants
   - Tests intégration store-API pour workflow complet
   - Tests E2E Selenium workflow vente avec corrections
   - Validation non-régression interface caisse existante

## Testing

### Standards de Test Applicables
- **Framework**: Vitest + React Testing Library pour tests unitaires et intégration
- **Location**: `frontend/src/components/tickets/test/` suivant pattern existant
- **Coverage Target**: 85% minimum pour nouveaux composants ticket
- **Integration with Existing**: Patterns de mock existants pour stores Zustand et API calls
- **Testing Requirements Spécifiques**:
  - Tests unitaires pour TicketDisplay avec données mockées
  - Tests intégration store pour modifications ticket temps réel
  - Tests E2E workflow vente complet avec corrections et finalisation
  - Tests persistance offline avec simulation déconnexion réseau

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-17 | 1.0 | Création story draft avec contexte architectural complet | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results

### Story Draft Validation Report

**Quick Summary:**
- Story readiness: READY
- Clarity score: 9/10
- Major gaps: None identified

**Validation Results:**

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS  |        |
| 2. Technical Implementation Guidance | PASS  |        |
| 3. Reference Effectiveness           | PASS  |        |
| 4. Self-Containment Assessment       | PASS  |        |
| 5. Testing Guidance                  | PASS  |        |

**Final Assessment: READY**
The story provides sufficient context for implementation. All acceptance criteria are clearly mapped to technical tasks, architecture references are comprehensive and specific, and testing guidance is complete. The developer agent has everything needed to implement the live ticket display functionality without requiring additional research.
