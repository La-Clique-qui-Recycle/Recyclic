# docker-compose.vps.yml
# Configuration de surcharge pour d√©ploiement sur VPS avec Traefik

networks:
  traefik-public:
    external: true

services:
  api:
    command: uvicorn recyclic_api.main:app --host 0.0.0.0 --port 8000 --proxy-headers --forwarded-allow-ips="*"
    environment:
      - HOST=0.0.0.0
      - ALLOWED_HOSTS=recyclic.jarvos.eu,localhost,127.0.0.1
      - CORS_ALLOW_ORIGINS=https://recyclic.jarvos.eu
      - BACKEND_CORS_ORIGINS=https://recyclic.jarvos.eu
      - FRONTEND_URL=https://recyclic.jarvos.eu
    networks:
      - traefik-public
      - recyclic-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.recyclic-api.rule=Host(`recyclic.jarvos.eu`) && PathPrefix(`/api`)"
      - "traefik.http.routers.recyclic-api.entrypoints=websecure"
      - "traefik.http.routers.recyclic-api.tls.certresolver=myresolver"
      - "traefik.http.routers.recyclic-api.priority=100"

      - "traefik.http.middlewares.recyclic-setproto.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.recyclic-api.middlewares=recyclic-setproto"

      - "traefik.http.services.recyclic-api.loadbalancer.server.port=8000"
      - "traefik.http.services.recyclic-api.loadbalancer.passhostheader=true"
      - "traefik.tags=touch-$(date +%s)"

  frontend:
    build:
      context: ./frontend
      args:
        VITE_API_URL: "https://recyclic.jarvos.eu/api"
    environment:
      - HOST=0.0.0.0
      - DANGEROUSLY_DISABLE_HOST_CHECK=true
    expose:
      - "80"
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.recyclic-frontend.rule=Host(`recyclic.jarvos.eu`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.recyclic-frontend.entrypoints=websecure"
      - "traefik.http.routers.recyclic-frontend.tls.certresolver=myresolver"
      - "traefik.http.routers.recyclic-frontend.priority=1"
      - "traefik.http.services.recyclic-frontend.loadbalancer.server.port=80"
