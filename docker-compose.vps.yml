# docker-compose.vps.yml
# Configuration de surcharge pour d√©ploiement sur VPS avec Traefik

networks:
  traefik-public:
    external: true

services:
  api:
    environment:
      - HOST=0.0.0.0
      - UVICORN_CMD_ARGS=
      - ALLOWED_HOSTS=localhost,127.0.0.1,recyclic.jarvos.eu
      - CORS_ALLOW_ORIGINS=https://recyclic.jarvos.eu
      - BACKEND_CORS_ORIGINS=https://recyclic.jarvos.eu
      - FRONTEND_URL=https://recyclic.jarvos.eu
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-public"
      - "traefik.http.routers.recyclic-api.rule=Host(`recyclic.jarvos.eu`) && PathPrefix(`/api`)"
      - "traefik.http.routers.recyclic-api.entrypoints=websecure"
      - "traefik.http.routers.recyclic-api.tls.certresolver=myresolver"
      - "traefik.http.routers.recyclic-api.priority=100"
      - "traefik.http.middlewares.recyclic-api-strip.stripprefix.prefixes=/api"
      - "traefik.http.middlewares.recyclic-api-host.headers.customrequestheaders.Host=localhost"
      - "traefik.http.middlewares.recyclic-api-host.headers.customrequestheaders.X-Forwarded-Host=localhost"
      - "traefik.http.middlewares.recyclic-api-host.headers.customrequestheaders.X-Forwarded-Proto=https"
      - "traefik.http.routers.recyclic-api.middlewares=recyclic-api-strip,recyclic-api-host"
      - "traefik.http.services.recyclic-api.loadbalancer.server.port=8000"
      - "traefik.http.services.recyclic-api.loadbalancer.passhostheader=false"

  frontend:
    build:
      context: ./frontend
      args:
        REACT_APP_API_URL: "https://recyclic.jarvos.eu/api"
    environment:
      - HOST=0.0.0.0
      - DANGEROUSLY_DISABLE_HOST_CHECK=true
    networks:
      - traefik-public
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.recyclic-frontend.rule=Host(`recyclic.jarvos.eu`) && !PathPrefix(`/api`)"
      - "traefik.http.routers.recyclic-frontend.entrypoints=websecure"
      - "traefik.http.routers.recyclic-frontend.tls.certresolver=myresolver"
      - "traefik.http.routers.recyclic-frontend.priority=1"
      - "traefik.http.services.recyclic-frontend.loadbalancer.server.port=80"
